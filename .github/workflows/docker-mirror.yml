name: Docker Mirror

on:
  workflow_dispatch:
    inputs:
      images:
        description: >-
          多行镜像列表，可包含 `--platform linux/amd64 image:tag` 形式；每行一条，支持 # 注释。
        required: true
        type: string

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAME_SPACE: ${{ secrets.ALIYUN_NAME_SPACE }}
  ALIYUN_REGISTRY_USER: ${{ secrets.ALIYUN_REGISTRY_USER }}
  ALIYUN_REGISTRY_PASSWORD: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Before freeing up disk space
        run: |
          echo "Before freeing up disk space"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: Maximize build space
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: "true"
          remove-haskell: "true"
          build-mount-path: "/var/lib/docker/"

      - name: Restart docker
        run: sudo service docker restart

      - name: Free up disk space complete
        run: |
          echo "Free up disk space complete"
          echo "=============================================================================="
          df -hT
          echo "=============================================================================="

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Aliyun Registry
        run: docker login -u "$ALIYUN_REGISTRY_USER" -p "$ALIYUN_REGISTRY_PASSWORD" "$ALIYUN_REGISTRY"

      - name: Mirror images to Aliyun
        env:
          IMAGES_INPUT: ${{ inputs.images }}
        run: |
          set -euo pipefail

          if [[ -z "${IMAGES_INPUT}" ]]; then
            echo "No images provided"
            exit 1
          fi

          declare -A duplicate_images
          declare -A temp_map

          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            name_space="${name_space}_"
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            if [[ -n "${temp_map[$image_name]:-}" ]]; then
              if [[ "${temp_map[$image_name]}" != "$name_space" ]]; then
                duplicate_images[$image_name]="true"
              fi
            else
              temp_map[$image_name]="$name_space"
            fi
          done <<< "$IMAGES_INPUT"

          while IFS= read -r line || [[ -n "$line" ]]; do
            [[ -z "$line" ]] && continue
            [[ "$line" =~ ^[[:space:]]*# ]] && continue

            echo "Processing: $line"
            docker pull $line

            platform=$(echo "$line" | awk -F'--platform[ =]' '{if (NF>1) print $2}' | awk '{print $1}')
            if [[ -n "$platform" ]]; then
              platform_prefix="${platform//\//_}_"
            else
              platform_prefix=""
            fi

            image=$(echo "$line" | awk '{print $NF}')
            image="${image%%@*}"
            image_name_tag=$(echo "$image" | awk -F'/' '{print $NF}')
            name_space=$(echo "$image" | awk -F'/' '{if (NF==3) print $2; else if (NF==2) print $1; else print ""}')
            image_name=$(echo "$image_name_tag" | awk -F':' '{print $1}')

            name_space_prefix=""
            if [[ -n "${duplicate_images[$image_name]:-}" && -n "$name_space" ]]; then
              name_space_prefix="${name_space}_"
            fi

            image_name_tag="${image_name_tag%%@*}"
            new_image="${ALIYUN_REGISTRY}/${ALIYUN_NAME_SPACE}/${platform_prefix}${name_space_prefix}${image_name_tag}"

            echo "Tagging $image -> $new_image"
            docker tag "$image" "$new_image"
            echo "Pushing $new_image"
            docker push "$new_image"

            echo "Cleaning up local images"
            docker rmi "$image" "$new_image" || true
            df -hT
          done <<< "$IMAGES_INPUT"

      - name: Logout Aliyun Registry
        if: always()
        run: docker logout "$ALIYUN_REGISTRY"
