services:
  postgres:
    image: postgres:16-alpine
    container_name: opencode-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=opencode
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ../../data/postgres:/var/lib/postgresql/data
    networks:
      - llbot_net

  redis:
    image: redis:7.4-alpine
    container_name: opencode-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - ../../data/redis:/data
    networks:
      - llbot_net

  pmhq:
    image: linyuchen/pmhq:latest
    platform: linux/amd64
    container_name: luckylillia-pmhq
    # PMHQ 通过 ptrace/进程注入 hook QQNT，默认 seccomp/capabilities 会阻止该行为。
    # 目前用 privileged 确保可用；最小权限目标见 docs/deployment.md。
    privileged: true
    # TODO(least-privilege): 验证后替换为：
    # cap_add: ["SYS_PTRACE"]
    # security_opt: ["seccomp=unconfined"]
    environment:
      - ENABLE_HEADLESS=false
      - AUTO_LOGIN_QQ=
    volumes:
      - ../../data/llbot/qq:/root/.config/QQ
      - ../../data/llbot/data:/app/llbot/data
    networks:
      - llbot_net

  luckylillia:
    image: linyuchen/llbot:latest
    platform: linux/amd64
    container_name: luckylillia
    env_file:
      - ../../configs/.env
      - ../../configs/secrets/.env
    environment:
      - ENABLE_WEBUI=true
      - WEBUI_PORT=3080
    entrypoint:
      - /bin/sh
      - /config/llbot-entrypoint.sh
    ports:
      - "3000:3000"
      - "3080:3080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ../../data/llbot/data:/app/llbot/data
      - ../../data/llbot/qq:/root/.config/QQ
      - ../../data/llbot/default_config.json:/config/default_config.json:ro
      - ../../scripts/llbot-entrypoint.sh:/config/llbot-entrypoint.sh:ro
    depends_on:
      - pmhq
    networks:
      - llbot_net

  opencode-bot-agent-adapter:
    image: ghcr.io/opencode-bot-agent/opencode-bot-agent:latest
    container_name: opencode-bot-agent-adapter
    command: ["bun", "run", "start:adapter"]
    env_file:
      - ../../configs/.env
      - ../../configs/secrets/.env
    environment:
      - REDIS_URL=redis://redis:6379
      - LLBOT_REGISTRY_PREFIX=llbot:registry
    volumes:
      - ../../data:/data
    depends_on:
      - redis
      - luckylillia
    networks:
      - llbot_net

  opencode-bot-agent-worker:
    image: ghcr.io/opencode-bot-agent/opencode-bot-agent:latest
    container_name: opencode-bot-agent-worker
    command: ["bun", "run", "start:worker"]
    env_file:
      - ../../configs/.env
      - ../../configs/secrets/.env
    environment:
      - REDIS_URL=redis://redis:6379
    volumes:
      - ../../data:/data
    depends_on:
      - redis
      - postgres
    networks:
      - llbot_net

networks:
  llbot_net:
    driver: bridge
