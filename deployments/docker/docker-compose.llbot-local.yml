services:
  postgres:
    image: postgres:16-alpine
    container_name: opencode-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=opencode
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
    ports:
      - "5432:5432"
    volumes:
      - ../../data/postgres:/var/lib/postgresql/data
      - ./postgres-init:/docker-entrypoint-initdb.d:ro
    networks:
      - llbot_net

  redis:
    image: redis:7.4-alpine
    container_name: opencode-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - "6379:6379"
    volumes:
      - ../../data/redis:/data
    networks:
      - llbot_net

  pmhq:
    image: linyuchen/pmhq:latest
    platform: linux/amd64
    container_name: luckylillia-pmhq
    # PMHQ 通过 ptrace/进程注入 hook QQNT，默认 seccomp/capabilities 会阻止该行为。
    # 目前用 privileged 确保可用；最小权限目标见 docs/deployment.md。
    privileged: true
    # TODO(least-privilege): 验证后替换为：
    # cap_add: ["SYS_PTRACE"]
    # security_opt: ["seccomp=unconfined"]
    environment:
      - ENABLE_HEADLESS=false
      - AUTO_LOGIN_QQ=
    volumes:
      - ../../data/llbot/qq:/root/.config/QQ
      - ../../data/llbot/data:/app/llbot/data
    networks:
      - llbot_net

  luckylillia:
    image: linyuchen/llbot:latest
    platform: linux/amd64
    container_name: luckylillia
    env_file:
      - ../../configs/.env
    environment:
      - ENABLE_WEBUI=true
      - WEBUI_PORT=3080
    entrypoint:
      - /bin/sh
      - /config/llbot-entrypoint.sh
    ports:
      - "3000:3000"
      - "3080:3080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ../../data/llbot/data:/app/llbot/data
      - ../../data/llbot/qq:/root/.config/QQ
      - ../../data/llbot/default_config.json:/config/default_config.json:ro
      - ../../scripts/llbot-entrypoint.sh:/config/llbot-entrypoint.sh:ro
    depends_on:
      - pmhq
    networks:
      - llbot_net

  opencode-bot-agent-adapter:
    image: ghcr.io/opencode-bot-agent/opencode-bot-agent:latest
    container_name: opencode-bot-agent-adapter
    command: ["bun", "run", "start:adapter"]
    env_file:
      - ../../configs/.env
    environment:
      - REDIS_URL=redis://redis:6379
      - LLBOT_REGISTRY_PREFIX=llbot:registry
    volumes:
      - ../../data:/data
    depends_on:
      - redis
      - luckylillia
    networks:
      - llbot_net

  opencode-bot-agent-worker:
    image: ghcr.io/opencode-bot-agent/opencode-bot-agent:latest
    container_name: opencode-bot-agent-worker
    command: ["bun", "run", "start:worker"]
    env_file:
      - ../../configs/.env
    environment:
      - REDIS_URL=redis://redis:6379
      - OPENCODE_SERVER_URL=http://opencode-server:4096
    volumes:
      - ../../data:/data
    depends_on:
      - redis
      - postgres
      - opencode-server
    networks:
      - llbot_net

  opencode-server:
    image: ghcr.io/opencode-bot-agent/opencode-bot-agent:latest
    container_name: opencode-server
    command:
      - bash
      - -lc
      - |
        set -euo pipefail

        mkdir -p "${HOME}/.local/share/opencode" "${HOME}/.config/opencode"

        if [ -n "${OPENAI_API_KEY:-}" ]; then
          cat > "${HOME}/.local/share/opencode/auth.json" <<EOF
          {
            "litellm": {
              "type": "api",
              "key": "${OPENAI_API_KEY}"
            }
          }
        EOF
          chmod 600 "${HOME}/.local/share/opencode/auth.json" || true
        fi

        cat > /tmp/opencode-config-gen.mjs <<'EOF'
        import * as fs from "node:fs/promises";
        import * as path from "node:path";

        const homeDir = process.env.HOME ?? "/data/opencode-home";
        const configPath = path.join(homeDir, ".config", "opencode", "config.json");
        const raw = (process.env.OPENCODE_MODELS ?? "").trim();
        const models = raw
          ? raw
              .split(",")
              .map((entry) => entry.trim())
              .filter(Boolean)
          : [];
        const unique = Array.from(new Set(models));
        if (unique.some((model) => model.includes("/"))) {
          throw new Error(
            "OPENCODE_MODELS must be comma-separated bare model names (no provider prefix)",
          );
        }

        const config = {
          $schema: "https://opencode.ai/config.json",
          ...(unique.length > 0
            ? {
                provider: {
                  litellm: {
                    npm: "@ai-sdk/openai-compatible",
                    options: {
                      baseURL: "{env:OPENAI_BASE_URL}",
                    },
                    models: Object.fromEntries(unique.map((name) => [name, { name }])),
                  },
                },
              }
            : {}),
          mcp: {
            talesofai: {
              type: "remote",
              url: "https://mcp.talesofai.cn/mcp",
              enabled: true,
              timeout: 600000,
              headers: {
                "x-token": "{env:NIETA_TOKEN}",
              },
            },
          },
        };

        await fs.mkdir(path.dirname(configPath), { recursive: true });
        const tmpPath = `${configPath}.tmp`;
        await fs.writeFile(tmpPath, JSON.stringify(config, null, 2), "utf8");
        await fs.rename(tmpPath, configPath);
        EOF

        bun run /tmp/opencode-config-gen.mjs
        rm -f /tmp/opencode-config-gen.mjs

        for c in \
          /usr/local/bun/install/global/node_modules/opencode-linux-x64-baseline/bin/opencode \
          /usr/local/bun/install/global/node_modules/opencode-linux-x64/bin/opencode \
          /usr/local/bun/install/global/node_modules/opencode-linux-x64-musl/bin/opencode; do
          if [ -x "$c" ]; then
            exec "$c" serve --hostname 0.0.0.0 --port 4096 \
              --cors https://app.opencode.ai \
              --cors https://opencode.ai
          fi
        done

        echo "opencode binary not found" >&2
        exit 1
    env_file:
      - ../../configs/.env
    environment:
      - HOME=/data/opencode-home
    volumes:
      - ../../data:/data
    ports:
      - "4096:4096"
    networks:
      - llbot_net

networks:
  llbot_net:
    driver: bridge
