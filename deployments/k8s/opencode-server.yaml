apiVersion: v1
kind: Service
metadata:
  name: opencode-server
  namespace: bot
spec:
  selector:
    app: opencode-server
  ports:
    - name: http
      port: 4096
      targetPort: http
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: opencode-server
  namespace: bot
spec:
  replicas: 1
  selector:
    matchLabels:
      app: opencode-server
  template:
    metadata:
      labels:
        app: opencode-server
    spec:
      containers:
        - name: opencode-server
          image: registry.cn-shanghai.aliyuncs.com/talesofai/opencode-bot-agent:latest
          command: ["bash", "-lc"]
          args:
            - |
              set -euo pipefail

              mkdir -p "${HOME}/.local/share/opencode" "${HOME}/.config/opencode"

              if [ -n "${OPENAI_API_KEY:-}" ]; then
                cat > "${HOME}/.local/share/opencode/auth.json" <<EOF
                {
                  "litellm": {
                    "type": "api",
                    "key": "${OPENAI_API_KEY}"
                  }
                }
              EOF
                chmod 600 "${HOME}/.local/share/opencode/auth.json" || true
              fi

              # Generate opencode config from env so OPENCODE_MODELS changes don't require YAML updates.
              cat > /tmp/opencode-config-gen.mjs <<'EOF'
              import * as fs from "node:fs/promises";
              import * as path from "node:path";

              const homeDir = process.env.HOME ?? "/data/opencode-home";
              const configPath = path.join(homeDir, ".config", "opencode", "config.json");
              const raw = (process.env.OPENCODE_MODELS ?? "").trim();
              const models = raw
                ? raw
                    .split(",")
                    .map((entry) => entry.trim())
                    .filter(Boolean)
                : [];
              const unique = Array.from(new Set(models));
              if (unique.some((model) => model.includes("/"))) {
                throw new Error(
                  "OPENCODE_MODELS must be comma-separated bare model names (no provider prefix)",
                );
              }

              const config = {
                $schema: "https://opencode.ai/config.json",
                ...(unique.length > 0
                  ? {
                      provider: {
                        litellm: {
                          npm: "@ai-sdk/openai-compatible",
                          options: {
                            baseURL: "{env:OPENAI_BASE_URL}",
                          },
                          models: Object.fromEntries(
                            unique.map((name) => [name, { name }]),
                          ),
                        },
                      },
                    }
                  : {}),
                mcp: {
                  talesofai: {
                    type: "remote",
                    url: "https://mcp.talesofai.cn/mcp",
                    enabled: true,
                    timeout: 600000,
                    headers: {
                      "x-token": "{env:NIETA_TOKEN}",
                    },
                  },
                },
              };

              await fs.mkdir(path.dirname(configPath), { recursive: true });
              const tmpPath = `${configPath}.tmp`;
              await fs.writeFile(tmpPath, JSON.stringify(config, null, 2), "utf8");
              await fs.rename(tmpPath, configPath);
              EOF

              bun run /tmp/opencode-config-gen.mjs
              rm -f /tmp/opencode-config-gen.mjs

              for c in \
                /usr/local/bun/install/global/node_modules/opencode-linux-x64-baseline/bin/opencode \
                /usr/local/bun/install/global/node_modules/opencode-linux-x64/bin/opencode \
                /usr/local/bun/install/global/node_modules/opencode-linux-x64-musl/bin/opencode; do
                if [ -x "$c" ]; then
                  exec "$c" serve --hostname 0.0.0.0 --port 4096 \
                    --cors https://app.opencode.ai \
                    --cors https://opencode.ai
                fi
              done

              echo "opencode binary not found" >&2
              exit 1
          env:
            # Store opencode state on the shared /data RWX volume so multiple replicas can serve the same sessions.
            - name: HOME
              value: "/data/opencode-home"
            - name: OPENAI_BASE_URL
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: OPENAI_BASE_URL
                  optional: true
            - name: OPENAI_API_KEY
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: OPENAI_API_KEY
                  optional: true
            - name: OPENCODE_MODELS
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: OPENCODE_MODELS
                  optional: true
            # Optional: enable HTTP basic auth (worker must use the same values).
            - name: OPENCODE_SERVER_USERNAME
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: OPENCODE_SERVER_USERNAME
                  optional: true
            - name: OPENCODE_SERVER_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: OPENCODE_SERVER_PASSWORD
                  optional: true
            # MCP token for talesofai MCP server (used by config.json header template).
            - name: NIETA_TOKEN
              valueFrom:
                secretKeyRef:
                  name: llbot-secrets
                  key: NIETA_TOKEN
                  optional: true
          ports:
            - name: http
              containerPort: 4096
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          volumeMounts:
            - name: data
              mountPath: /data
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: bot-data
