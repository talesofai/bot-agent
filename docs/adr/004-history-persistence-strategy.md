# ADR-004: 会话历史存储与读取策略

## 背景

我们需要存储和读取用户的会话历史 (History)。历史记录以 `jsonl` (每行一个 JSON 对象) 格式存储。

之前的讨论在"流式读取"、"反向读取"、"使用系统 tail 命令"之间摇摆，导致了无意义的复杂性增加。

## 约束

1. **数据规模**：单 Session 历史记录受 Token 限制，物理体积预计不超过 1MB (100k tokens)。
2. **技术栈**：TypeScript (Bun)，拒绝引入 C 风格的 Buffer 操作或外部 shell 依赖。
3. **优先级**：业务逻辑清晰度 > 极致 IO 性能。

## 决策

我们决定采用 **"全量读取 + 按需解析"** 的策略。

1. **写入 (Append)**：使用 `fs.appendFile` 原子追加。
2. **读取 (Read)**：
   - 使用 `fs.readFile` 将文件一次性读入内存字符串。
   - **不**进行全量 `JSON.parse`。
   - 仅查找字符串末尾的 `maxEntries` 个换行符，切分出需要的片段。
   - 仅对切分后的片段进行 `JSON.parse`。

## 后果

- **优点**：代码极其简洁，无外部依赖，且避免了无效的 JSON 序列化开销（这是 CPU 最密集的步骤）。
- **风险**：如果文件意外膨胀到 100MB+，OOM 风险增加。但鉴于业务约束，此风险接受。
