# ADR-004: 会话历史存储与读取策略

## 背景

我们需要存储和读取用户的会话历史 (History)。历史记录以 `jsonl` (每行一个 JSON 对象) 格式存储。

之前的讨论在"流式读取"、"反向读取"、"使用系统 tail 命令"之间摇摆，导致了无意义的复杂性增加。

## 约束

1. **数据规模**：历史文件体积可控，但允许异常增长。
2. **技术栈**：TypeScript (Bun)，避免外部 shell 依赖。
3. **优先级**：业务逻辑清晰度 > 极致 IO 性能。

## 决策

我们决定采用 **"尾部读取 + 按需解析"** 的策略。

1. **写入 (Append)**：使用 `fs.appendFile` 原子追加。
2. **读取 (Read)**：
   - 使用 `Bun.file().slice()` 读取文件尾部窗口。
   - 若窗口内换行不足以覆盖 `maxEntries`，则向前扩展窗口直到满足或抵达文件开头。
   - **不**进行全量 `JSON.parse`。
   - 仅对切分后的片段进行 `JSON.parse`。

## 后果

- **优点**：代码清晰，无外部依赖，避免全量 JSON 解析的 CPU 浪费，同时减少内存峰值。
- **风险**：若单行极长或文件异常膨胀，窗口扩展仍可能带来较大内存分配；通过 `maxBytes` 可进一步约束。
