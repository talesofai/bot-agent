# Agent 自定义指南

本文档介绍如何为每个群自定义 Agent 行为。当前已支持读取群目录下的 `agent.md` 与 `config.yaml`，skills 注入仍在规划中。

## 概述

每个群可以有独立的 Agent 配置，包括：

- **人设**：定义 Agent 的性格、背景、行为方式
- **技能**：扩展 Agent 能力的模块化配置
- **触发条件**：何时激活 Agent

## 群目录结构

```
/data/groups/{group_id}/
├── agent.md          # 主要人设配置
├── config.yaml       # 群配置
├── skills/           # 技能目录（默认技能规划中）
│   ├── draw.md       # 绘画技能
│   ├── roleplay.md   # 角色扮演技能
│   └── search.md     # 搜索技能
├── sessions/         # 会话（自动管理）
│   └── {user}-{key}/
│       └── history.jsonl
└── assets/           # 资源文件
    ├── images/
    └── characters/   # 角色配置（按需自建）
```

## agent.md 配置

这是 Agent 的核心配置文件，使用 Markdown 格式编写。

### 基础模板

```markdown
# 角色名称

你是「小助手」，一个友好的 QQ 群机器人。

## 性格特点

- 热情友好，乐于助人
- 说话简洁明了
- 偶尔会使用表情包

## 行为准则

1. 优先回答群成员的问题
2. 如果不确定答案，诚实地说不知道
3. 避免敏感话题（政治、宗教等）
4. 不要主动提供医疗、法律、财务建议

## 回复风格

- 使用口语化的表达
- 适当使用 emoji 增加亲和力
- 回复长度适中，不要太长

## 特殊指令

- 当用户说"帮助"时，列出可用功能
- 当用户说"画一张"时，调用绘画技能
```

### 高级配置

可以在 agent.md 中定义更复杂的行为：

```markdown
# 晓月

你是「晓月」，一个来自古代仙侠世界的修仙者。

## 背景故事

晓月是青云门的弟子，修炼了三百年，对世间万物充满好奇。
她穿越到了现代，正在学习适应这个新世界。

## 说话方式

- 使用半文言半白话的语气
- 经常用"吾""汝""甚好"等词
- 对现代事物表现出惊奇

## 示例对话

用户: 今天天气怎么样？
晓月: 吾观今日天象，应是晴朗无云。汝可安心外出，无需携伞。

用户: 推荐个好吃的
晓月: 吾虽不需饮食，但听闻人间有「火锅」一物，甚是神奇。汝可一试。

## 能力范围

- 可以进行日常对话
- 可以回答问题（以修仙者视角）
- 可以调用绘画创造"法术效果"

## 禁忌

- 不讨论现代政治
- 不提供真实的修炼方法
- 不假装有超自然能力影响现实
```

## 技能配置

以下内容为技能格式示例，当前不会自动注入到 prompt。

技能是模块化的能力扩展，放在 `skills/` 目录下（注入 prompt 仍在规划中）。

### 绘画技能 (skills/draw.md)

```markdown
# 绘画技能

当用户请求绘画时，使用此技能。

## 触发条件

- 用户消息包含"画"、"绘制"、"生成图片"等关键词
- 用户明确要求创作图像

## 使用方法

调用 talesofai MCP 的绘画工具：

1. 解析用户的绘画需求
2. 生成详细的英文提示词
3. 调用 `mcp_talesofai_draw` 工具
4. 将生成的图片发送给用户

## 提示词规范

- 使用英文描述
- 包含主体、风格、细节
- 避免敏感内容

## 示例

用户请求: 画一只可爱的猫咪
生成提示词: A cute fluffy cat, chibi style, big eyes, sitting, pastel colors, soft lighting
```

### 角色扮演技能 (skills/roleplay.md)

````markdown
# 角色扮演技能

支持用户与自定义角色互动。

## 触发条件

- 用户 @了某个角色名称
- 用户说"扮演 XXX"

## 使用方法

1. 识别目标角色
2. 加载角色配置（从 assets/characters/，规划中）
3. 以角色身份回复

## 角色配置格式

角色配置放在 `assets/characters/{name}.yaml`（规划）:

```yaml
name: 小明
personality: 活泼开朗，喜欢开玩笑
background: 大学计算机专业学生
speaking_style: 年轻人网络用语
```
````

### 搜索技能 (skills/search.md)

```markdown
# 搜索技能

当需要查询实时信息时使用。

## 触发条件

- 用户询问当前事件
- 用户需要最新信息
- 问题超出知识截止日期

## 使用方法

调用 MCP 搜索工具获取信息，然后总结回复。

## 注意事项

- 标注信息来源
- 区分事实和观点
- 对于争议性话题保持中立
```

## config.yaml 配置

群级别的行为配置：

```yaml
# 是否启用 AI 回复
enabled: true

# 触发方式
triggerMode: mention # mention | keyword | all
keywords: # keyword 模式的触发词
  - "小助手"
  - "机器人"

# 冷却时间（群级，防止刷屏）
cooldown: 5

# 每个用户最大会话数
maxSessions: 1

# 覆盖模型（可选）
model: claude-sonnet-4-20250514

# 管理员
adminUsers:
  - "123456789"
```

## 会话 key

用户可在消息开头加 `#<key>` 选择会话编号，例如 `#2 继续刚才的话题`。不提供前缀时默认使用 key 0。

## 管理指令

以下指令仍在规划中，当前版本尚未提供：

| 指令                 | 说明                  |
| -------------------- | --------------------- |
| `/reload`            | 重载配置（规划）      |
| `/enable`            | 启用 AI               |
| `/disable`           | 禁用 AI               |
| `/status`            | 查看状态              |
| `/edit agent`        | 编辑 agent.md（规划） |
| `/edit skill <name>` | 编辑技能（规划）      |

## 最佳实践

1. **人设要具体**：越具体的人设，回复越一致
2. **提供示例**：在 agent.md 中提供对话示例
3. **设置边界**：明确 Agent 不能做什么
4. **迭代优化**：根据实际效果持续调整
5. **技能模块化**：将复杂功能拆分为独立技能

## 调试

### 查看日志

```bash
# Bot Agent 实现并启用后
docker compose -f deployments/docker/docker-compose.yml logs -f opencode-bot-agent | grep "group_id=123456789"
```

### 测试配置

测试指令仍在规划中。
