# 架构设计

本文档描述 Bot Agent 的系统架构和技术选型。

## 系统概览

```
┌─────────────────────────────────────────────────────────────────┐
│                          QQ 平台                                 │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ NTQQ 协议
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    协议层 (LuckyLilliaBot)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Milky     │  │   OneBot    │  │   Satori    │              │
│  │   Server    │  │     11      │  │   Server    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ Milky API (HTTP/WebSocket)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    消息处理层 (Bot Agent)                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   Event     │  │   Message   │  │   Group     │              │
│  │   Handler   │  │   Router    │  │   Manager   │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ 消息内容
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Agent 层 (opencode)                         │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                    opencode Agent                        │    │
│  │  ┌───────────┐  ┌───────────┐  ┌───────────────────┐    │    │
│  │  │  System   │  │   Tool    │  │    MCP Client     │    │    │
│  │  │  Prompt   │  │   Calls   │  │  (talesofai MCP)  │    │    │
│  │  └───────────┘  └───────────┘  └───────────────────────┘    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      存储层 (文件系统)                           │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │ Group 123   │  │ Group 456   │  │ Group 789   │              │
│  │ ├ agent.md  │  │ ├ agent.md  │  │ ├ agent.md  │              │
│  │ ├ skills/   │  │ ├ skills/   │  │ ├ skills/   │              │
│  │ └ context/  │  │ └ context/  │  │ └ context/  │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

## 核心组件

### 1. 协议层 - LuckyLilliaBot

**职责**：处理 QQ 协议，提供统一的消息接口

- 运行在独立容器中
- 支持多种协议输出：Milky（首选）、OneBot 11、Satori
- 处理 QQ 登录、心跳、消息收发

**为什么选择 LuckyLilliaBot**：

- 协议实现完整，功能稳定
- 支持 Milky 新协议，生态活跃
- 相比 NapCatQQ 封号风险更低

### 2. 消息处理层 - Bot Agent

**职责**：消息路由、群管理、Agent 调用

核心模块：

- **Event Handler**：监听 Milky 事件（消息、群变动等）
- **Message Router**：根据群号路由到对应群目录
- **Group Manager**：管理群配置和生命周期

### 3. Agent 层 - opencode

**职责**：AI 推理和工具调用

**为什么选择 opencode**：

- 支持非交互式模式：`opencode -p "prompt" -c /path/to/group`
- 原生支持 MCP 协议，可直接使用 talesofai MCP
- 支持多种 AI 模型（OpenAI/Anthropic/Gemini）
- 与项目 TypeScript (Bun) 技术栈一致，便于集成

**调用方式**：

```bash
opencode -p "用户消息内容" \
         -c /data/groups/{group_id} \
         -f json \
         --quiet
```

### 4. 存储层 - 群目录

**职责**：持久化群配置和上下文

每个群独立目录，结构如下：

```
/data/groups/{group_id}/
├── agent.md          # 群 Agent 人设和指令
├── skills/           # 自定义技能
│   ├── draw.md       # 绘画技能
│   └── roleplay.md   # 角色扮演技能
├── context/          # 对话上下文
│   └── history.jsonl # 历史消息
├── assets/           # 群资源
└── config.yaml       # 群配置
```

## 数据流

### 消息处理流程

```
1. QQ 群消息 → LuckyLilliaBot
2. LuckyLilliaBot → Milky Event → Bot Agent
3. Bot Agent 判断是否需要 AI 处理
   - 是：构造 prompt，调用 opencode
   - 否：直接处理（如指令）
4. opencode 执行推理，可能调用 MCP 工具
5. opencode 返回响应
6. Bot Agent → Milky API → LuckyLilliaBot → QQ
```

### Agent 调用流程

```
1. Bot Agent 准备工作目录（切换到群目录）
2. 加载 agent.md 作为 system prompt
3. 调用 opencode 非交互模式
4. opencode 读取群目录下的 skills/ 和 context/
5. 执行推理，可能调用 talesofai MCP 工具
6. 返回 JSON 格式响应
7. Bot Agent 解析响应，发送消息
```

## 技术选型

| 组件     | 选型                 | 理由                                              |
| -------- | -------------------- | ------------------------------------------------- |
| 语言     | TypeScript           | 与 opencode/LuckyLilliaBot 一致，Discord 生态成熟 |
| QQ 协议  | LuckyLilliaBot       | 协议全面，稳定性好                                |
| 协议规范 | Milky                | 新一代标准，生态活跃                              |
| Agent    | Anthropic/OpenAI SDK | 直接 API 调用，灵活可控                           |
| 多平台   | Adapter 模式         | 统一接口，QQ/Discord 可扩展                       |
| 配置格式 | YAML + Markdown      | 人类可读，Git 友好                                |
| 部署     | Docker + K8s         | 云原生，易扩展                                    |

## 扩展性设计

### 多平台支持

架构设计为消息处理层与协议层解耦：

```
                 ┌─────────────────┐
                 │   Bot Agent     │
                 │  (消息处理层)   │
                 └────────┬────────┘
                          │
          ┌───────────────┼───────────────┐
          │               │               │
          ▼               ▼               ▼
    ┌──────────┐    ┌──────────┐    ┌──────────┐
    │   QQ     │    │ Discord  │    │ Telegram │
    │ Adapter  │    │ Adapter  │    │ Adapter  │
    └──────────┘    └──────────┘    └──────────┘
```

### MCP 工具扩展

通过 talesofai MCP 扩展 Agent 能力：

- 捏 Ta：角色创建和扮演
- 绘画：AI 绘图生成
- 搜索：联网搜索
- 更多自定义工具...

## 部署架构

### K8s 部署

```
┌─────────────────────────────────────────────────────────────┐
│                        Kubernetes Cluster                    │
│                                                              │
│  ┌────────────────┐  ┌────────────────┐  ┌──────────────┐  │
│  │   Pod:         │  │   Pod:         │  │   PVC:       │  │
│  │ LuckyLillia    │  │   Bot Agent    │  │  群数据存储  │  │
│  │                │  │                │  │              │  │
│  │ Port: 3000     │  │ + opencode     │  │ /data/groups │  │
│  │ (Milky API)    │  │ + MCP Client   │  │              │  │
│  └────────────────┘  └────────────────┘  └──────────────┘  │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```
