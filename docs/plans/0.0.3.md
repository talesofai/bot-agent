# 0.0.3 Phase 2: QQ 适配器实现

目标：完成 Milky WebSocket 接入，具备 QQ 群消息收发与最小可用的重连能力。

> 注：本文件为历史计划记录，实际实现以当前代码与文档为准。

## 背景

根据 `docs/plans/0.0.2.md`，本阶段目标是完成 Milky WebSocket 接入，具备 QQ 群消息收发与最小可用的重连能力。项目已有 `@saltify/milky-node-sdk` 依赖，并定义了 `PlatformAdapter` 接口。

## 参考资料

- **架构文档**: `docs/architecture.md` - 定义了多平台适配器模式
- **Eridanus 示例**: `example/Eridanus/framework_common/framework_util/websocket_fix.py` - 展示了 WebSocket 连接、重连、消息处理模式
- **现有接口**: `src/types/platform.ts` - 定义了 `PlatformAdapter`、`UnifiedMessage`、`SendMessageOptions`

---

## 新增文件

```
src/adapters/
├── index.ts                   # 适配器统一导出
└── qq/
    ├── index.ts               # QQ 适配器模块入口
    ├── adapter.ts             # PlatformAdapter 实现
    ├── connection.ts          # WebSocket 连接管理
    ├── parser.ts              # 消息解析
    ├── sender.ts              # 消息发送
    └── __tests__/
        ├── parser.test.ts     # 解析器测试
        └── connection.test.ts # 连接测试
```

---

## 模块说明

### adapter.ts

实现 `PlatformAdapter` 接口的 `QQAdapter` 类：

- `connect()`: 初始化 Milky WebSocket 连接
- `disconnect()`: 关闭连接，清理资源
- `onMessage(handler)`: 注册消息处理回调
- `sendMessage(options)`: 发送文本/图片消息
- `getBotUserId()`: 获取当前 Bot ID

### connection.ts

Milky WebSocket 连接管理：

- WebSocket 连接与事件监听
- 心跳机制（基于 Milky 协议）
- 断线重连与指数退避策略（初始 5s，最大 60s）

### parser.ts

消息解析：

- 将 Milky 事件解析为 `UnifiedMessage` 格式
- 处理群消息、私聊消息事件
- 提取发送者信息、消息内容

### sender.ts

消息发送：

- 文本消息发送
- 图片消息发送（URL 或 Base64）
- 请求响应处理

---

## 核心功能

| 功能               | 描述                               |
| ------------------ | ---------------------------------- |
| **WebSocket 连接** | 基于 Milky 协议连接 LuckyLilliaBot |
| **断线重连**       | 指数退避策略（5s → 60s max）       |
| **消息接收**       | 解析群消息/私聊为 `UnifiedMessage` |
| **消息发送**       | 支持文本和图片消息                 |
| **Bot 识别**       | 自动检测 @机器人                   |
| **优雅关闭**       | SIGINT/SIGTERM 处理                |

---

## 修改文件

| 文件         | 变更                               |
| ------------ | ---------------------------------- |
| src/index.ts | 集成 QQ 适配器、消息处理、优雅关闭 |
| CHANGELOG.md | 添加 0.0.3 版本记录                |

---

## 测试

### 单元测试

```bash
bun test src/adapters/qq/__tests__
```

测试结果：

- 14 tests passed (parser: 9, connection: 5)
- 0 failures

### 验证命令

```bash
# TypeScript 类型检查
bunx tsc --noEmit

# ESLint 代码检查
bun run lint
```

---

## 使用方法

1. 配置 `configs/secrets/.env`：

   ```env
   MILKY_URL=ws://localhost:3000
   ```

2. 启动：
   ```bash
   bun run dev
   ```

---

## 里程碑达成

- [x] **M1**: 连接稳定（可收事件，断线自动重连）
- [x] **M2**: 可发送文本消息
- [x] **M3**: 完成图片发送与基本测试覆盖

## 依赖与环境

- `MILKY_URL` 必填
- `GROUPS_DATA_DIR` 指向持久化目录
- 运行命令统一使用 `bun`
