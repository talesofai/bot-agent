# 0.0.30 Vision: Discord 世界/角色系统（Global World Hub）

> 注：这是计划/愿景文档，用来约束方向与取舍；不是“把想法全塞进来”的许愿池。  
> 相关设计：`docs/design/world-system.md`，流程：`docs/design/world-system-flows.md`。

## 核心判断

值得做：它解决“用户想创造自己的世界并持续运营”的真实需求，而且可以用**少量、清晰的数据结构**落地。做法要笨，但必须清楚；不要靠一堆 if/else 伪装成系统。

## 我们要做什么

在 Discord 内提供一套“世界中心”能力：

- 用户创建世界（世界卡 + 规则 + 入口子空间）
- 世界对所有人可浏览（能看到）
- 只有加入世界的人才能进入游玩（不能进入：由 Discord Role 强制）
- 世界内角色系统（用户创建角色卡；roleplay=用户以该角色身份发言，bot 作为旁白/世界系统回应）
- 世界统计（访客数/角色数，持久化）
- 正典/编年史/冲突检测（最小闭环）
- 地图生成/更新（对接 banana，先做接口与落地）

## 为什么做

- **产出可复用资产**：世界卡/规则/地图/正典是持久化内容，能反复被新玩家消费。
- **用户留存靠进度**：可视化统计和编年史让世界“有历史”，不是一次性对话。
- **系统边界清晰**：读写分离（所有人可读，成员可写），权限模型不靠模型输出。

## 关键约束（已经确认）

- 只做 Discord。
- 世界**全局共享**；先固定 **单 `homeGuild`**（世界子空间只存在于创建它的 guild）。
- “不能进入”使用 **World Role** 做 Discord 权限层准入。
- 上下文只用 opencode session；不再依赖 PostgreSQL history。
- 计数必须持久化：
  - `访客数 = join 成员数`
  - `角色数 = 世界下角色数`
- ID 必须数字自增：`worldId`、`characterId`。
- 默认值：
  - `world.createPolicy = admin`
  - `character.visibility = world`
- 未加入世界：bot **必须响应**（拒绝/引导 join），不能装死。

## 非目标（先别发疯）

- 不做多 `homeGuild` 挂载/镜像同一世界（以后真需要再说）。
- 不做 per-user 频道 overwrites（会把系统做成垃圾）。
- 不做 WebUI（本阶段只 Discord）。
- 不做“浏览量”这种不可观测指标：Discord 频道浏览无法可靠统计；访客数用 join 即可。
- 不做 NPC 24 小时常驻代理（先把世界/角色/正典闭环做完）。

## 关键设计（怎么做）

一句话：**把“世界”建模成虚拟 groupId（`world_{worldId}`），复用现有 session/skills 注入链路。**

- 路由：`channelId -> worldId -> groupId = world_{worldId}`
- 会话隔离：会话目录自然变成 `.../sessions/{botId}/world_{worldId}/...`
- 权限：World Role 控制频道写权限；bot 额外做命令级校验（防绕过）
- 持久化：
  - Redis：自增 ID、meta、映射、集合计数（AOF/RDB）
  - `/data`：世界卡/规则/角色卡/地图/正典/事件流（大文本）

## 指令与功能清单（必须覆盖）

> “需要的指令”不是口头承诺：每个指令都要有明确的权限、数据读写与失败响应。

### 世界系统

- `/world create`：创建世界（生成草稿 + 私密话题多轮补全；在话题中 `/world publish` 发布后创建子空间）
- `/world open <worldId>`：打开世界编辑话题（仅创作者；私密可见）
- `/world publish`：发布草稿世界（在世界构建/编辑话题中执行）
- `/world list`：列出所有可探索世界（全局）
- `/world info <worldId>`：查看世界卡与入口信息（全局可读）
- `/world rules <worldId>`：查看世界规则与底层逻辑（全局可读）
- `/world join`：加入世界（在世界子空间频道内可省略 worldId；必须在 `homeGuild` 执行以赋 role）
- `/world stats <worldId>`：访客数、角色数、近期事件（全局可读）
- `/world canon <关键词>`：搜索世界正典（全局可读）

### 角色系统

- `/character create`：创建角色卡（需已 join；默认 `visibility=world`）
- `/character view <characterId>|[@用户]`：查看角色卡（遵循 visibility）
- `/character update <字段> <值>`：更新角色信息（仅创建者）
- `/character migrate <目标世界>`：角色迁移（仅创建者 + 需 join 目标世界）
- `/character history`：查看角色经历与成就记录（仅创建者/本人）
- `/character act <characterId>`：设置你在本世界的当前角色（roleplay 开关）

### 世界观工具

- `/map generate <描述>`：文字 → 世界地图（banana）
- `/map update <worldId> <变化>`：根据剧情更新地图（banana）
- `/check <设定>`：冲突检测（检索正典并提示冲突点）
- `/submit <类型> <内容>`：正典提案（格式化草案，等待创作者确认）
- `/chronicle add <事件>`：编年史记录（写入世界历史）
- `/npc create <名字> <性格>`：NPC 代理（延后实现，先把接口与落地点定好）

## 流程文档

- 交互流程与失败分支：`docs/design/world-system-flows.md`

## TODO（按依赖顺序）

### A. 基础与数据结构

- [ ] 定义 Redis key 规范（world/character/index/mapping/membership/stats）
- [ ] 定义 `WorldMeta`/`CharacterMeta` 的 schema（zod）与序列化
- [ ] 定义 `/data/worlds/{worldId}` 文件布局与原子写入约定

### B. Discord 子空间与权限

- [ ] `/world create`：创建 role + category + channels + overwrites（@everyone 只读；role 可写）
- [ ] 记录 `channelId -> worldId` 映射，确保路由可用
- [ ] `/world join`：加入成员集合 + 赋 role（仅 `homeGuild`）

### C. 路由与会话隔离（最容易翻车的部分）

- [ ] Dispatch 阶段引入 world channel 识别：命中则 `groupId = world_{worldId}`
- [ ] world roleplay channel always-on：绕开 mention/keyword 触发限制
- [ ] 未 join 的写操作：统一拒绝 + 指令提示（不要散落在各处写特判）

### D. 指令实现（先读后写）

- [ ] `/world list|info|rules|stats`（全局可读）
- [ ] `/world canon`（先做最小：文件/索引检索）
- [ ] `/character view`（含 visibility 校验）
- [ ] `/character create`（写角色卡文件 + world 角色计数）
- [ ] `/character act`（写入 `(worldId,userId)->characterId` 状态）
- [ ] `/submit`（草案落地）
- [ ] `/chronicle add`（发布正典）
- [ ] `/check`（冲突检测：读取正典 + 总结冲突）

### E. banana 集成（先把接口固定）

- [ ] `/map generate|update` 的调用协议与落地目录（图片/元数据）
- [ ] 地图更新写入事件流，方便回放

### F. Skills（bot 的 opencode skills，不是 Codex skills）

- [ ] `configs/skills/world-design-card/SKILL.md`（从文档规范世界卡）
- [ ] `configs/skills/character-card/SKILL.md`（从文档规范角色卡）
- [ ] `configs/skills/world-readonly/SKILL.md`（roleplay 前强制读取世界信息）

### G. 清理（跟需求一致）

- [ ] 文档/部署里标注或移除 Postgres 依赖（只保留 Redis + /data）
- [ ] 更新 `docs/getting-started.md`/`docs/deployment.md` 的环境变量说明

### H. 验证

- [ ] `bun run check` 全绿
- [ ] Discord 手工验证脚本（创建世界→join→发言→计数→角色创建→roleplay）

## 验证标准

- 所有命令都有明确的权限与失败响应（未 join 不装死）。
- 世界 roleplay 频道消息进入独立 session（`groupId = world_{worldId}` 可在日志/目录结构验证）。
- `/world stats` 的访客数/角色数在进程重启后仍正确（Redis 持久化）。
- `bun run check` 全绿。

## 风险点（提前写出来，别等线上爆炸）

- Discord 资源创建频率限制：`/world create` 需要做幂等/失败可恢复（至少别留下半残 world）。
- 路由映射丢失：`channelId -> worldId` 是生命线，必须有自检与修复工具（后续可以补 `/world repair <id>`）。
- 权限绕过：Role 做入口，但命令仍需 server-side 校验成员资格（别信 Discord UI）。
