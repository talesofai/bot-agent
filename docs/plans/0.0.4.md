# 0.0.4 Phase 3: 群存储开发计划

目标：实现群配置和数据持久化，为 Agent 提供群独立的配置和技能存储。

> 注：本文件为历史计划记录，实际实现以当前代码与文档为准。

## 范围

- 实现 GroupStore 类管理群数据
- 群目录结构自动创建
- agent.md（人设配置）加载
- skills/ 目录技能加载
- config.yaml 群配置解析
- 配置热更新（chokidar）

## 群目录结构

```
/data/groups/
├── {group_id}/
│   ├── agent.md          # Agent 人设和系统提示词
│   ├── config.yaml       # 群配置（触发模式、冷却等）
│   ├── skills/           # 自定义技能
│   │   ├── draw.md       # 绘画技能
│   │   └── roleplay.md   # 角色扮演技能
│   └── assets/           # 群资源文件
└── sessions/{botId}/{groupId}/{userId}/{sessionId}/
    ├── meta.json
    └── workspace/
```

## 分步执行

1. GroupStore 类骨架
   - 新增 `src/store/group.ts` 模块
   - 实现群目录路径管理
   - 实现群列表扫描

2. 目录结构
   - 自动创建群目录和子目录
   - 默认配置文件生成

3. agent.md 加载
   - 读取并解析 agent.md 文件
   - 提取 System Prompt 内容
   - 支持 frontmatter 元数据

4. skills/ 技能加载
   - 扫描 skills/ 目录
   - 加载所有 .md 技能文件
   - 技能格式标准化

5. config.yaml 解析
   - 使用 zod 定义配置 schema
   - 支持默认值合并
   - 配置验证

6. 热更新支持
   - 使用 chokidar 监听文件变化
   - 自动重载配置和技能
   - 防抖处理

## 配置类型定义

```typescript
interface GroupConfig {
  enabled: boolean;
  triggerMode: "mention" | "keyword" | "all";
  keywords: string[];
  cooldown: number;
  adminUsers: string[];
  model?: string;
}

interface GroupData {
  id: string;
  path: string;
  config: GroupConfig;
  agentPrompt: string;
  skills: Skill[];
}

interface Skill {
  name: string;
  content: string;
  enabled: boolean;
}
```

## 依赖与环境

- `GROUPS_DATA_DIR` 环境变量指向群数据根目录
- 运行命令统一使用 `bun`
- 依赖 chokidar 实现文件监听

## 里程碑

- M1: GroupStore 可读取群列表和基础配置
- M2: agent.md 和 skills/ 正确加载
- M3: 配置热更新生效

## 测试

- 群目录创建与扫描测试
- 配置加载与验证测试
- 热更新回调触发测试
