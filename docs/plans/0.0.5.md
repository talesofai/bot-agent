# 0.0.5 多平台适配器系统

目标：实现多平台可配置选择的适配器系统，为后续添加 Discord 等平台做好架构准备。

> 注：本文件为历史计划记录，实际实现以当前代码与文档为准。

## 背景

项目已有 `PlatformAdapter` 接口和 `QQAdapter` 实现，但入口文件硬编码 `new QQAdapter()`，无法通过配置选择平台。

## 范围

- 扩展配置支持平台选择
- 创建 adapter factory 工厂函数
- 重构入口文件使用动态 adapter 创建
- 解耦 QQAdapter 对全局 config 的依赖

## 变更文件

### 新增

- `src/adapters/factory.ts` - 适配器工厂函数

### 修改

- `src/config.ts` - 新增 PLATFORM、DISCORD_TOKEN、DISCORD_APPLICATION_ID
- `src/adapters/index.ts` - 导出 factory
- `src/adapters/qq/adapter.ts` - 移除 config 依赖，url 必须通过 options 传入
- `src/index.ts` - 使用 createAdapter(config) 替代硬编码

## 配置项

| 变量                     | 类型                | 默认值 | 说明                                          |
| ------------------------ | ------------------- | ------ | --------------------------------------------- |
| `PLATFORM`               | `"qq" \| "discord"` | `"qq"` | 选择平台                                      |
| `MILKY_URL`              | `string`            | -      | QQ 平台 Milky URL（可选，PLATFORM=qq 时必须） |
| `DISCORD_TOKEN`          | `string`            | -      | Discord Bot Token（预留）                     |
| `DISCORD_APPLICATION_ID` | `string`            | -      | Discord 应用 ID（预留）                       |

## 使用方式

```bash
# QQ 平台（默认）
PLATFORM=qq MILKY_URL=ws://... bun run dev

# Discord 平台（待实现）
PLATFORM=discord DISCORD_TOKEN=... bun run dev
```

## 后续步骤

添加 Discord 支持时需要：

1. 创建 `src/adapters/discord/` 目录结构

   ```
   discord/
   ├── index.ts       # 导出 DiscordAdapter
   ├── adapter.ts     # PlatformAdapter 实现
   ├── connection.ts  # Discord Gateway 连接
   ├── parser.ts      # 事件解析
   └── sender.ts      # 消息发送
   ```

2. 实现 `DiscordAdapter` 类
   - 使用 Discord Gateway API 或 discord.js 库
   - 实现 `PlatformAdapter` 接口

3. 更新 `factory.ts`
   ```typescript
   case "discord":
     if (!config.DISCORD_TOKEN) {
       throw new Error("DISCORD_TOKEN is required for Discord platform");
     }
     return new DiscordAdapter({ token: config.DISCORD_TOKEN });
   ```
