# 0.0.7 Phase 3: 代码重构与优化 (Code Review Fixes)

目标：基于代码审查 (Code Review) 反馈，解决架构与实现中的关键问题，提升系统稳定性、性能与代码质量。

> 注：本文件为历史计划记录，实际实现以当前代码与文档为准。

## 背景

在 `data/merge.txt` (及 `data/reviews.md`) 中收到的 Code Review 指出了一系列从“极差”到“不可接受”的问题。主要集中在数据类型处理、I/O 模型、正则表达式性能、运行时一致性以及连接管理的复杂性上。本版本旨在彻底修复这些技术债务。

## 参考资料

- **Review 意见**: `data/merge.txt` / `data/reviews.md`
- **现有架构**: `docs/architecture.md`
- **运行时决策**: `docs/adr/002-runtime-selection.md` (确认使用 Bun)

---

## 进度概览

已完成：

- ID 保持 string，避免精度问题。
- GroupStore 全面改为异步 IO，并行加载群组。
- GroupStore 拆分为 Repository/Watcher，按需加载。
- 热路径正则缓存。
- Docker 运行时切换到 Bun。
- 连接逻辑扁平化，重连/关闭逻辑幂等。
- responseCallbacks 清理超时定时器，避免泄漏。
- 解析消息支持 ArrayBuffer/TypedArray/Blob。
- groupId 解析改用 `path.relative`，移除脆弱的字符串替换。
- agent.md frontmatter 使用 Zod 校验与 gray-matter 解析。
- 手动 connect 与自动重连定时器竞态已处理。
- 文件变更防抖已恢复。
- CONFIG_PATH 环境变量已支持。
- 文档状态已与实现对齐。

待完成：

- 无。

## 修改文件

| 文件                            | 变更                                                                                                   |
| ------------------------------- | ------------------------------------------------------------------------------------------------------ |
| `src/adapters/qq/sender.ts`     | **[FIX]** 移除 ID 的 `Number()` 强制转换，保持 `string` 类型传递。                                     |
| `src/store/group.ts`            | **[FIX]** 将同步 `readFileSync` 替换为异步 `fs/promises.readFile`，消除 Event Loop 阻塞。              |
| `src/adapters/qq/parser.ts`     | **[PERF]** 优化 `checkMentionsBotInRaw`，避免热路径中动态创建 RegExp。                                 |
| `deployments/docker/Dockerfile` | **[FIX]** 基础镜像从 `node:20-alpine` 切换为 `oven/bun:1-alpine`，与 ADR 保持一致。                    |
| `src/adapters/qq/connection.ts` | **[REFACTOR]** 简化 WebSocket 重连逻辑，使其基于 `onclose` 事件驱动，并确保 `scheduleReconnect` 幂等。 |
| `src/adapters/factory.ts`       | **[CLEANUP]** 移除注释掉的 Discord 适配器死代码。                                                      |
| `src/config.ts`                 | **[FIX]** 用 Zod 在启动阶段强制校验平台依赖字段。                                                      |
| `src/types/group.ts`            | **[FIX]** 为 agent frontmatter 增加 Zod schema。                                                       |
| `src/store/repository.ts`       | **[REFACTOR]** 抽离文件读取与解析逻辑，使用 gray-matter。                                              |
| `src/store/watcher.ts`          | **[REFACTOR]** 抽离文件监听与防抖处理。                                                                |

---

## 详细变更说明

### 1. ID 数据类型安全 (`src/adapters/qq/sender.ts`)

- **问题**: `channelId` 被强制转换为 `Number`，存在精度丢失风险 (IEEE 754) 且无法兼容未来非数字 ID (如 Discord Snowflake)。
- **修复**: 删除 `Number(channelId)` 转换与 `isNaN` 检查。`UnifiedMessage` 接口应透传 `string` 类型的 ID。

### 2. 异步 I/O 规范化 (`src/store/group.ts`)

- **问题**: `async` 函数内部使用 `readFileSync`，阻塞事件循环，导致高并发或文件系统延迟时 Bot 假死。
- **修复**: 使用 `import { readFile } from "node:fs/promises"` 替代同步调用。
  - 群组加载改为并行 `Promise.all`。
  - 使用 `path.relative` 解析 groupId，移除脆弱的字符串替换。

### 3. 正则性能优化 (`src/adapters/qq/parser.ts`)

- **问题**: 热路径 `checkMentionsBotInRaw` 中每次通过 `new RegExp` 动态构建正则。
- **修复**: 缓存编译好的正则实例，或改用 `String.prototype.indexOf` 等更高效的字符串操作（如果逻辑允许）。

### 4. 运行时一致性 (`deployments/docker/Dockerfile`)

- **问题**: ADR 002 明确选定 Bun，但 Dockerfile 仍使用 Node.js，导致文档与实现分裂 (Schizophrenia)。
- **修复**: 重写 Dockerfile，使用 Official Bun Image。

### 5. 连接逻辑简化 (`src/adapters/qq/connection.ts`)

- **问题**: 重连逻辑分散在 `doConnect` Promise catch、`initialErrorHandler`、`runtimeErrorHandler` 中，且定时器未做幂等处理，可能导致双重重连。
- **修复**:
  - 确保 `scheduleReconnect` 幂等（清除旧 timer）。
  - 简化状态机，以 `onclose` 为单一事实来源驱动重连。
  - 移除过度的 Promise 包装。
  - 消息解码支持 `ArrayBuffer`/`TypedArray`/`Blob`，避免解析失败丢消息。
  - `responseCallbacks` 超时定时器在断开时统一清理。
  - 手动 `connect()` 时清理重连定时器，避免覆盖已建立连接。

### 6. 配置与 frontmatter 校验 (`src/config.ts`, `src/types/group.ts`)

- **问题**: 配置依赖关系由工厂手动检查，frontmatter 无结构验证。
- **修复**: 使用 Zod 在启动期校验平台依赖字段与 frontmatter 结构。

### 7. 文件变更去抖 (`src/store/group.ts`)

- **问题**: 保存/写入触发多次 `reload` 与回调，造成不必要的重复加载。
- **修复**: 在 watcher 回调中增加 per-group 防抖窗口。

---

## 验证计划

### 自动化测试

- 运行现有测试套件，确保修改未破坏现有逻辑：
  ```bash
  bun test
  ```
- 尤其关注 `connection.test.ts`，可能需要根据重构后的逻辑调整测试用例。
- 增加二进制消息与发送消息参数的测试用例。
- 增加断线重连的测试用例。

### 手动验证

- **构建验证**:

  ```bash
  docker build -f deployments/docker/Dockerfile -t llbot:0.0.7 .
  ```

  确保构建成功且能通过 Bun 正常启动。

- **功能验证**:
  - 发送包含 `@机器人` 的消息，验证正则优化后的识别准确性。
  - 触发网络断开（模拟），验证重连逻辑是否平滑且无重复重连日志。

---

## 里程碑

- [x] **M1**: 核心代码修复 (ID, I/O, Regex, Clean up)
- [x] **M2**: 重连逻辑重构 (Connection Logic)
- [x] **M3**: 运行时环境切换 (Dockerfile to Bun)
- [x] **M4**: 测试补齐 (Reconnect)
