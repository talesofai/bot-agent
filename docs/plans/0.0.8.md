# 0.0.8 Plan: 分布式 Opencode 落地 (User-Isolated)

## 目标

实现基于 NAS 的 **用户独占 Session** 架构，移除复杂的归档/合并逻辑，专注于隔离与并发。

## 参考资料

- **架构设计**: `docs/design/distributed_opencode_zh.md`

## 实施阶段

### Phase 1: 基础目录与隔离 (Isolation)

- [x] **Store 重构**: 适配 `/data/groups/{gid}/{sessions,assets}` 结构。
- [x] **Session Manager**:
  - 实现 `createSession(groupId, userId, key=0)`:
    - 如果 `key >= maxSessions`，则拒绝。
    - 目录名: `sessions/{userId}-{key}`。
  - 实现 `meta.json` 管理。
- [x] **Opencode Launcher**:
  - 确保 `cwd = sessions/{sid}/workspace`。
  - 确保只读挂载/访问上层资源。

### Phase 2: 生命周期与并发 (Lifecycle)

### Phase 2: 生命周期与并发 (Lifecycle)

- [x] **Runtime Lock**: 使用 Redis 分布式锁 (`SET key val NX EX 600`)。
  - 机制: 这里的锁仅用于保证同一 Session 不会被并发执行，不依赖文件系统原子性。
  - 恢复: Redis TTL 自动过期 (10min)。
- [x] **Resume 逻辑**:
  - 检查锁 -> 失败则 **BullMQ Delayed Retry (2s)**。
  - 成功 -> 启动 Opencode -> **Redis Expire 续期心跳** -> 执行 -> 退出 -> 释放锁。
- [x] **History 管理**:
  - Resume 时加载 `history.jsonl`。
  - 交互结束后将 Input/Output 追加写入 `history.jsonl`。
- [x] **Job Queue 适配**: 使用 BullMQ 替代文件队列，天然支持重试和并发。
- [x] **Worker Pool**: 使用 BullMQ Worker，支持并发配置。
- [x] **清理策略**: 实现长周期 TTL (30天)。

### Phase 3: WebUI/Admin 适配 (Management)

- [ ] **Skills 编辑**: 确保 WebUI 可以读写 `groups/{gid}/skills/`。
- [ ] **Session 查看**: (可选) 管理员查看活跃 Session。

## 验证计划

1.  **隔离性**: User A 的 Session 绝对不可被 User B 写入。
2.  **只读保护**: Opencode 尝试写入 `skills/` 应失败 (或被忽略)。
3.  **并发**: 150 并发下 NAS 目录创建无报错。
